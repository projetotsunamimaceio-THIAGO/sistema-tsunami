<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSUNAMI - Relatórios</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #0a0a0f; color: white; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(139, 92, 246, 0.1); }
        .neon-violet { color: #8b5cf6; text-shadow: 0 0 10px rgba(139, 92, 246, 0.5); }
        .btn-violet { border: 1px solid #8b5cf6; background: rgba(139, 92, 246, 0.1); transition: 0.3s; }
        .btn-violet:hover { background: #8b5cf6; color: white; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        select, input[type="month"] { background: #1a1a2e; border: 1px solid #8b5cf6; color: white; padding: 5px 10px; border-radius: 8px; outline: none; font-size: 12px; }
        .table-ranking { width: 100%; font-size: 13px; }
        .table-ranking th { text-align: left; padding: 8px; border-bottom: 1px solid rgba(139, 92, 246, 0.2); color: #8b5cf6; position: sticky; top: 0; background: #0a0a0f; }
        .table-ranking td { padding: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        /* Adicionado scroll para caso a lista de 15 alunos fique muito grande em telas menores */
        .ranking-container { max-height: 600px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #8b5cf6 transparent; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-10">
            <a href="index.html" class="btn-violet px-4 py-2 rounded-lg text-sm uppercase font-bold text-white">
                <i class="fas fa-arrow-left mr-2"></i> Voltar
            </a>
            <h1 class="text-3xl font-bold neon-violet tracking-widest uppercase text-center">Estatísticas</h1>
            
            <div class="flex flex-wrap gap-2 justify-center">
                <select id="filtroTipo" onchange="alternarFiltros()">
                    <option value="periodo">Por Período</option>
                    <option value="especifico">Mês Específico</option>
                </select>
                <select id="filtroPeriodo" onchange="processarDados()">
                    <option value="30">Últimos 30 dias</option>
                    <option value="90">Últimos 90 dias</option>
                    <option value="180">Últimos 180 dias</option>
                    <option value="365">Último Ano</option>
                </select>
                <input type="month" id="filtroMes" class="hidden" onchange="processarDados()">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="glass p-6 rounded-2xl text-center border-b-4 border-violet-500">
                <h3 class="text-xs uppercase text-violet-400 mb-1">Total de Alunos</h3>
                <p id="totalAlunos" class="text-4xl font-bold">0</p>
            </div>
            <div class="glass p-6 rounded-2xl text-center border-b-4 border-cyan-500">
                <h3 class="text-xs uppercase text-cyan-400 mb-1">Turmas Ativas</h3>
                <p id="totalTurmas" class="text-4xl font-bold">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-sm font-bold uppercase mb-4 text-violet-300">Alunos por Turma</h3>
                <div class="chart-container"><canvas id="chartPizza"></canvas></div>
            </div>
            <div class="glass p-6 rounded-2xl">
                <h3 class="text-sm font-bold uppercase mb-4 text-cyan-300">Presença vs Faltas</h3>
                <div class="chart-container"><canvas id="chartColunas"></canvas></div>
            </div>
            <div class="glass p-6 rounded-2xl md:col-span-2">
                <h3 class="text-sm font-bold uppercase mb-4 text-emerald-300">Evolução de Presenças</h3>
                <div class="chart-container"><canvas id="chartLinhas"></canvas></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="glass p-6 rounded-2xl border-t-2 border-emerald-500">
                <h3 class="text-sm font-bold uppercase mb-4 text-emerald-400"><i class="fas fa-star mr-2"></i> Ranking: 15 Mais Frequentes</h3>
                <div class="ranking-container">
                    <table class="table-ranking" id="rankingPresenca">
                        <thead><tr><th>Aluno</th><th>Turma</th><th class="text-right">Total</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="glass p-6 rounded-2xl border-t-2 border-rose-500">
                <h3 class="text-sm font-bold uppercase mb-4 text-rose-400"><i class="fas fa-exclamation-triangle mr-2"></i> Ranking: 15 Mais Faltas</h3>
                <div class="ranking-container">
                    <table class="table-ranking" id="rankingFaltas">
                        <thead><tr><th>Aluno</th><th>Turma</th><th class="text-right">Total</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        const CORES_PALETA = ['#06b6d4', '#f59e0b', '#f43f5e', '#8b5cf6', '#ec4899', '#3b82f6', '#ffffff'];

        function alternarFiltros() {
            const tipo = document.getElementById('filtroTipo').value;
            document.getElementById('filtroPeriodo').classList.toggle('hidden', tipo !== 'periodo');
            document.getElementById('filtroMes').classList.toggle('hidden', tipo !== 'especifico');
            processarDados();
        }

        function initCharts() {
            const config = { 
                plugins: { legend: { labels: { color: 'white', font: { size: 10 }, usePointStyle: true } } }, 
                maintainAspectRatio: false 
            };
            charts.pizza = new Chart(document.getElementById('chartPizza'), { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: CORES_PALETA }] }, options: config });
            charts.colunas = new Chart(document.getElementById('chartColunas'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Presenças', backgroundColor: '#10b981', data: [] }, { label: 'Faltas', backgroundColor: '#f43f5e', data: [] }] }, options: { ...config, scales: { x: { ticks: { color: 'white' } }, y: { ticks: { color: 'white' }, beginAtZero: true } } } });
            charts.linhas = new Chart(document.getElementById('chartLinhas'), { type: 'line', data: { labels: [], datasets: [] }, options: { ...config, scales: { x: { ticks: { color: 'white' } }, y: { ticks: { color: 'white' }, beginAtZero: true, stepSize: 1 } } } });
        }

        function processarDados() {
            const alunos = JSON.parse(localStorage.getItem('tsunami_alunos')) || [];
            const freq = JSON.parse(localStorage.getItem('tsunami_freq')) || {};
            const tipoFiltro = document.getElementById('filtroTipo').value;
            const agora = new Date();
            
            const mapaAlunos = {};
            const statsIndividuais = {}; 

            alunos.forEach(a => { 
                const nomeKey = a.nome.trim().toUpperCase();
                mapaAlunos[nomeKey] = a.turma || "S/T";
                statsIndividuais[nomeKey] = { P: 0, F: 0, turma: a.turma || "S/T", nomeOriginal: a.nome };
            });
            
            const turmasUnicas = [...new Set(alunos.map(a => a.turma || "S/T"))].sort();
            document.getElementById('totalAlunos').innerText = alunos.length;
            document.getElementById('totalTurmas').innerText = turmasUnicas.length;

            const distTurmas = {};
            alunos.forEach(a => distTurmas[a.turma || "S/T"] = (distTurmas[a.turma || "S/T"] || 0) + 1);
            charts.pizza.data.labels = Object.keys(distTurmas);
            charts.pizza.data.datasets[0].data = Object.values(distTurmas);
            charts.pizza.update();

            const dadosTurmaColunas = {};
            const evolucaoPorData = {}; 

            Object.entries(freq).forEach(([chave, status]) => {
                if (chave.endsWith('-txt')) return;
                const partes = chave.split('|');
                if (partes.length < 2) return;
                
                const nomeRaw = partes[0].trim().toUpperCase();
                const dataISO = partes[1];
                const dataF = new Date(dataISO + "T00:00:00");
                
                let incluir = false;
                if (tipoFiltro === 'periodo') {
                    const dias = parseInt(document.getElementById('filtroPeriodo').value);
                    const limite = new Date(); limite.setDate(agora.getDate() - dias);
                    if (dataF >= limite) incluir = true;
                } else {
                    const mesSel = document.getElementById('filtroMes').value;
                    if (mesSel && dataISO.startsWith(mesSel)) incluir = true;
                }

                if (incluir) {
                    const tNome = mapaAlunos[nomeRaw] || "S/T";
                    if (!dadosTurmaColunas[tNome]) dadosTurmaColunas[tNome] = { P: 0, F: 0 };
                    if (!evolucaoPorData[dataISO]) evolucaoPorData[dataISO] = {};

                    if (status === 'P' || status === 'A') {
                        dadosTurmaColunas[tNome].P++;
                        evolucaoPorData[dataISO][tNome] = (evolucaoPorData[dataISO][tNome] || 0) + 1;
                        if (statsIndividuais[nomeRaw]) statsIndividuais[nomeRaw].P++;
                    } else if (status === 'F') {
                        dadosTurmaColunas[tNome].F++;
                        if (statsIndividuais[nomeRaw]) statsIndividuais[nomeRaw].F++;
                    }
                }
            });

            charts.colunas.data.labels = Object.keys(dadosTurmaColunas);
            charts.colunas.data.datasets[0].data = Object.values(dadosTurmaColunas).map(d => d.P);
            charts.colunas.data.datasets[1].data = Object.values(dadosTurmaColunas).map(d => d.F);
            charts.colunas.update();

            const datasOrd = Object.keys(evolucaoPorData).sort();
            charts.linhas.data.labels = datasOrd.map(d => d.split('-').reverse().slice(0,2).join('/'));
            const dataPointsGeral = datasOrd.map(dt => turmasUnicas.reduce((s, t) => s + (evolucaoPorData[dt][t] || 0), 0));

            const datasetsFinal = [{ label: "TOTAL GERAL", data: dataPointsGeral, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 4, fill: true, tension: 0.3, pointRadius: 5 }];
            turmasUnicas.forEach((t, idx) => {
                const pts = datasOrd.map(dt => evolucaoPorData[dt][t] || 0);
                if (pts.some(v => v > 0)) datasetsFinal.push({ label: t, data: pts, borderColor: CORES_PALETA[idx % CORES_PALETA.length], backgroundColor: 'transparent', borderWidth: 2, tension: 0.3 });
            });
            charts.linhas.data.datasets = datasetsFinal;
            charts.linhas.update();

            // Renderizar Rankings - ALTERADO PARA 15 ALUNOS
            const listaStats = Object.values(statsIndividuais);
            
            const maisFreq = [...listaStats].sort((a, b) => b.P - a.P).slice(0, 15);
            document.querySelector('#rankingPresenca tbody').innerHTML = maisFreq.map(a => `<tr><td>${a.nomeOriginal}</td><td class="text-gray-400">${a.turma}</td><td class="text-right font-bold text-emerald-400">${a.P}</td></tr>`).join('');

            const maisFaltas = [...listaStats].sort((a, b) => b.F - a.F).slice(0, 15);
            document.querySelector('#rankingFaltas tbody').innerHTML = maisFaltas.map(a => `<tr><td>${a.nomeOriginal}</td><td class="text-gray-400">${a.turma}</td><td class="text-right font-bold text-rose-400">${a.F}</td></tr>`).join('');
        }

        initCharts();
        processarDados();
    </script>
</body>
</html>