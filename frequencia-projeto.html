<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frequ√™ncia Projeto - TSUNAMI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #030b16;
            --card-bg: #0d1726;
            --border-color: #1a2a3a;
            --accent-blue: #00d4ff;
            --btn-bg: #142132;
            --text-gray: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); color: white; padding: 20px; }

        header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        .btn-nav { 
            width: 40px; height: 40px; border-radius: 50%; 
            background: var(--btn-bg); border: 1px solid var(--border-color);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; text-decoration: none;
        }

        .page-badge {
            background: var(--btn-bg); padding: 10px 25px; border-radius: 30px;
            border: 1px solid var(--border-color); font-weight: bold; font-size: 13px;
            letter-spacing: 1px; text-transform: uppercase;
        }

        .date-control { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .month-display { font-size: 18px; font-weight: bold; letter-spacing: 1px; min-width: 220px; text-transform: uppercase; }

        .filter-container { position: absolute; right: 20px; top: 85px; }
        select { 
            background: var(--card-bg); color: white; border: 1px solid var(--border-color);
            padding: 10px 15px; border-radius: 10px; outline: none; width: 220px; font-size: 14px;
        }

        /* AJUSTE PARA VISUALIZA√á√ÉO MOBILE: COLUNA FIXA */
        .projeto-container { 
            background: var(--card-bg); border-radius: 12px; 
            overflow-x: auto; border: 1px solid var(--border-color);
            margin-top: 20px;
            position: relative;
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { border-bottom: 1px solid var(--border-color); text-align: center; background: var(--card-bg); }

        /* FIXANDO A COLUNA DO NOME */
        .td-aluno { 
            text-align: left !important; 
            padding-left: 15px; 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            width: 180px; 
            min-width: 180px;
            border-right: 2px solid var(--border-color);
        }

        th.td-aluno { z-index: 11; }

        .col-dia { width: 65px; min-width: 65px; }
        .col-faltas { width: 70px; min-width: 70px; }

        td { padding: 12px 0; }

        .aluno-nome { font-weight: 600; font-size: 12px; display: block; color: #f1f5f9; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .aluno-turma { font-size: 9px; color: var(--accent-blue); font-weight: bold; }

        .btn-action-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .btn-all { background: #2563eb; color: white; border: none; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; cursor: pointer; }
        .btn-share { color: var(--accent-blue); font-size: 13px; cursor: pointer; padding: 4px; }

        .box { 
            width: 28px; height: 28px; border-radius: 6px; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; margin: 0 auto; cursor: pointer;
            background: #1e293b; color: #475569;
        }

        .st-presente { background: #10b981 !important; color: white !important; }
        .st-falta { background: #ef4444 !important; color: white !important; }
        .st-atraso { background: #f59e0b !important; color: white !important; }
        .st-justificado { background: #3b82f6 !important; color: white !important; }
        .box.st-nm { background: transparent !important; border: 1px solid #1e293b !important; color: #1e293b !important; pointer-events: none; opacity: 0.2; }

        .falta-badge { width: 24px; height: 24px; border-radius: 50%; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; margin: 0 auto; }
        .val-total { color: #10b981; font-weight: bold; font-size: 13px; }
        #toast { position: fixed; bottom: 30px; right: 30px; background: #10b981; color: white; padding: 12px 25px; border-radius: 10px; display: none; font-weight: bold; z-index: 1000;}
    </style>
</head>
<body>

<div id="toast">SALVO!</div>

<header>
    <a href="pagina-inicial.html" class="btn-nav"><i class="fas fa-chevron-left"></i></a>
    <div class="page-badge">FREQU√äNCIA PROJETO</div>
</header>

<div class="date-control">
    <div class="btn-nav" onclick="navegarMes(-1)"><i class="fas fa-chevron-left"></i></div>
    <span class="month-display" id="label-mes">...</span>
    <div class="btn-nav" onclick="navegarMes(1)"><i class="fas fa-chevron-right"></i></div>
</div>

<div class="filter-container">
    <select id="sel-turma" onchange="carregarProjeto()">
        <option value="">TODAS AS TURMAS</option>
    </select>
</div>

<div class="projeto-container">
    <table>
        <thead>
            <tr id="h-days">
                <th class="td-aluno">NOME / TURMA</th>
                <th class="col-faltas">FALTAS</th>
            </tr>
            <tr id="row-all-actions">
                <td class="td-aluno" style="font-weight: bold; font-size: 11px; color: white;">MARCAR TODOS</td>
                <td>‚Äî</td>
            </tr>
        </thead>
        <tbody id="b-table"></tbody>
        <tfoot>
            <tr id="f-total">
                <td class="td-aluno" style="text-align:right !important; padding-right: 15px; font-size:11px; color:#64748b;">PRESEN√áAS:</td>
                <td>‚Äî</td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
    const URL_SISTEMA = "https://script.google.com/macros/s/AKfycbzLOv51v8QZhJb4YVVzsq8jluarlT2iato9QKKYnlWoIkgAVec_pX_-mSaybRhh7EB8/exec";
    const URL_TURMAS = "https://script.google.com/macros/s/AKfycbw3Zy6DuTZO61C-RpD6hrnOFjXkFHNZQYDFKLFQAZ4hFVere7K31Y2W9FCBAhsgfOiSvQ/exec";

    let dataFoco = new Date(); 
    let diasDoMes = [];
    let listaAlunosCache = [];
    let freqCache = [];

    function showToast() {
        const t = document.getElementById('toast');
        t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1000);
    }

    function atualizarDias() {
        const ano = dataFoco.getFullYear(), mes = dataFoco.getMonth();
        document.getElementById('label-mes').innerText = `${dataFoco.toLocaleString('pt-BR', { month: 'long' }).toUpperCase()} DE ${ano}`;
        diasDoMes = [];
        let d = new Date(ano, mes, 1);
        while (d.getMonth() === mes) {
            if (d.getDay() === 2 || d.getDay() === 5 || d.getDay() === 6) {
                let y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
                let label = d.getDay() === 2 ? "TER" : d.getDay() === 5 ? "SEX" : "S√ÅB";
                diasDoMes.push({ data: `${y}-${m}-${day}`, label: label });
            }
            d.setDate(d.getDate() + 1);
        }
    }

    function parseDataManual(valor) {
        if (!valor) return null;
        let s = valor.toString().split('T')[0];
        let partes = s.includes('-') ? s.split('-') : s.split('/');
        let d = (partes[0].length === 4) ? new Date(partes[0], partes[1] - 1, partes[2]) : new Date(partes[2], partes[1] - 1, partes[0]);
        if (isNaN(d.getTime())) return null;
        d.setHours(0,0,0,0); return d;
    }

    async function carregarProjeto() {
        const body = document.getElementById('b-table'), head = document.getElementById('h-days'), rowActions = document.getElementById('row-all-actions'), foot = document.getElementById('f-total'), turmaFiltro = document.getElementById('sel-turma').value;
        body.innerHTML = '<tr><td colspan="30" style="padding:50px; color:gray; text-align:center;">CARREGANDO...</td></tr>';
        
        while(head.children.length > 2) head.removeChild(head.children[1]);
        while(rowActions.children.length > 2) rowActions.removeChild(rowActions.children[1]);
        while(foot.children.length > 2) foot.removeChild(foot.children[1]);

        const inicioMes = new Date(dataFoco.getFullYear(), dataFoco.getMonth(), 1).getTime();
        const fimMes = new Date(dataFoco.getFullYear(), dataFoco.getMonth() + 1, 0).getTime();

        diasDoMes.forEach(item => {
            const th = document.createElement('th'); th.className = "col-dia"; th.innerHTML = `${item.label}<br>${item.data.split('-')[2]}/${item.data.split('-')[1]}`;
            head.insertBefore(th, head.lastElementChild);
            
            const tdAct = document.createElement('td'); 
            tdAct.innerHTML = `<div class="btn-action-group"><button class="btn-all" onclick="cicloColuna('${item.data}')">ALL</button><i class="fas fa-share-alt btn-share" onclick="compartilharDia('${item.data}')"></i></div>`;
            rowActions.insertBefore(tdAct, rowActions.lastElementChild);

            const tdFoot = document.createElement('td'); 
            tdFoot.id = `total-dia-${item.data}`; tdFoot.className = "val-total"; tdFoot.innerText = "0";
            foot.insertBefore(tdFoot, foot.lastElementChild);
        });

        try {
            const resp = await fetch(URL_SISTEMA + "?table=arena&_=" + Date.now());
            const dados = await resp.json();
            listaAlunosCache = dados.alunos;
            freqCache = dados.frequencia;
            const listaAlunosFiltrados = listaAlunosCache.filter(a => turmaFiltro === "" || a.turma === turmaFiltro);
            body.innerHTML = '';

            listaAlunosFiltrados.forEach(aluno => {
                const dMat = parseDataManual(aluno.data_matricula);
                const dVal = parseDataManual(aluno.data_de_validade_fim);
                const dRemat = parseDataManual(aluno.data_rematricula);

                if (dMat && dMat.getTime() > fimMes) return;
                if (dVal && dVal.getTime() < inicioMes && (!dRemat || dRemat.getTime() > fimMes)) return;

                let tr = document.createElement('tr');
                let html = `<td class="td-aluno"><span class="aluno-nome">${aluno.nome}</span><span class="aluno-turma">‚ô¶ ${aluno.turma}</span></td>`;
                
                diasDoMes.forEach(item => {
                    const dDia = parseDataManual(item.data).getTime();
                    let bloqueado = false;

                    if (dMat && dDia < dMat.getTime()) {
                        bloqueado = true;
                    } else if (dVal && dDia > dVal.getTime()) {
                        if (!dRemat || dDia < dRemat.getTime()) {
                            bloqueado = true;
                        }
                    }

                    if (bloqueado) {
                        html += `<td><div class="box st-nm">N/M</div></td>`;
                    } else {
                        const f = freqCache.find(x => x.aluno === aluno.nome && x.data.includes(item.data));
                        const st = f ? f.status : '';
                        html += `<td><div id="btn-${aluno.nome.replace(/\s/g,'')}-${item.data}" class="box st-${st}" onclick="cicloIndividual('${aluno.nome}','${item.data}')">${getIcon(st)}</div></td>`;
                    }
                });
                html += `<td><div id="faltas-${aluno.nome.replace(/\s/g,'')}" class="falta-badge">0</div></td>`;
                tr.innerHTML = html; body.appendChild(tr);
            });
            atualizarSomatorias();
        } catch (e) { body.innerHTML = '<tr><td colspan="30" style="text-align:center;">Erro ao carregar dados.</td></tr>'; }
    }

    function getIcon(st) {
        if (st === 'falta') return '<i class="fas fa-times"></i>'; 
        if (st === 'presente') return '<i class="fas fa-check"></i>'; 
        if (st === 'atraso') return '!'; 
        if (st === 'justificado') return 'J';
        return '‚Äî';
    }

    function atualizarSomatorias() {
        diasDoMes.forEach(item => {
            let p = 0;
            document.querySelectorAll(`[id$='-${item.data}']`).forEach(el => {
                if (el.classList.contains('st-presente') || el.classList.contains('st-atraso')) p++;
            });
            let c = document.getElementById(`total-dia-${item.data}`); if(c) c.innerText = p;
        });

        document.querySelectorAll('#b-table tr').forEach(tr => {
            const nomeSpan = tr.querySelector('.aluno-nome');
            if(!nomeSpan) return;
            const nome = nomeSpan.innerText;
            let f = 0; const id = nome.replace(/\s/g,'');
            diasDoMes.forEach(item => {
                const el = document.getElementById(`btn-${id}-${item.data}`);
                if (el && (el.classList.contains('st-falta') || el.classList.contains('st-justificado'))) f++;
            });
            let b = document.getElementById(`faltas-${id}`); if(b) b.innerText = f;
        });
    }

    async function cicloIndividual(nome, dia) {
        const el = document.getElementById(`btn-${nome.replace(/\s/g,'')}-${dia}`);
        if(!el) return;
        const ciclo = ['', 'falta', 'presente', 'atraso', 'justificado'];
        let atual = ''; ciclo.forEach(s => { if(el.classList.contains('st-'+s)) atual = s; });
        let prox = ciclo[(ciclo.indexOf(atual) + 1) % ciclo.length];
        let obs = "";
        if (prox === 'justificado') {
            obs = prompt("JUSTIFICATIVA:") || "Sem justificativa";
            if (obs === null) return;
        }
        el.className = `box st-${prox}`; el.innerHTML = getIcon(prox);
        enviarDados(nome, dia, prox, obs);
        const fIdx = freqCache.findIndex(x => x.aluno === nome && x.data.includes(dia));
        if(fIdx > -1) { freqCache[fIdx].status = prox; freqCache[fIdx].obs = obs; }
        else { freqCache.push({ aluno: nome, data: dia, status: prox, obs: obs }); }
        showToast(); 
        atualizarSomatorias();
    }

    function cicloColuna(dia) {
        const boxes = Array.from(document.querySelectorAll(`[id$='-${dia}']`)).filter(el => !el.classList.contains('st-nm'));
        if (!boxes.length) return;
        const ciclo = ['', 'falta', 'presente'];
        let atual = ''; ciclo.forEach(s => { if(boxes[0].classList.contains('st-'+s)) atual = s; });
        let prox = ciclo[(ciclo.indexOf(atual) + 1) % ciclo.length];
        boxes.forEach(el => {
            const nomeRaw = el.id.replace('btn-', '').replace('-'+dia, '');
            const alunoOriginal = listaAlunosCache.find(a => a.nome.replace(/\s/g,'') === nomeRaw);
            if (alunoOriginal) {
                el.className = `box st-${prox}`; el.innerHTML = getIcon(prox);
                enviarDados(alunoOriginal.nome, dia, prox, "");
                const fIdx = freqCache.findIndex(x => x.aluno === alunoOriginal.nome && x.data.includes(dia));
                if(fIdx > -1) { freqCache[fIdx].status = prox; freqCache[fIdx].obs = ""; }
                else { freqCache.push({ aluno: alunoOriginal.nome, data: dia, status: prox, obs: "" }); }
            }
        });
        showToast(); 
        setTimeout(atualizarSomatorias, 500);
    }

    async function compartilharDia(dia) {
        const dataFormatada = dia.split('-').reverse().join('/');
        let mensagem = `*Frequ√™ncia PROJETO*\nDia: ${dataFormatada}\n\n`;
        const turmasMap = {}; const justificados = []; let totalGeral = 0;
        listaAlunosCache.forEach(aluno => {
            const freq = freqCache.find(f => f.aluno === aluno.nome && f.data.includes(dia));
            if (!freq) return;
            if (freq.status === 'presente' || freq.status === 'atraso') {
                if (!turmasMap[aluno.turma]) turmasMap[aluno.turma] = [];
                const icon = freq.status === 'atraso' ? ' ‚ö†Ô∏è' : '';
                turmasMap[aluno.turma].push(`${aluno.nome}${icon}`);
                totalGeral++;
            } else if (freq.status === 'justificado') {
                justificados.push(`*${aluno.nome}*\n(${freq.obs || 'Sem justificativa'})`);
            }
        });
        for (const turma in turmasMap) {
            mensagem += `*TURMA*\n${turmasMap[turma].join('\n')}\n-Total: ${turmasMap[turma].length} alunos\n\n`;
        }
        mensagem += `#Total/PROJETO: ${totalGeral} alunos\n\n`;
        if (justificados.length > 0) { mensagem += `üó£Ô∏è - Justificados\n${justificados.join('\n\n')}`; }
        if (navigator.share) {
            try { await navigator.share({ title: 'Frequ√™ncia PROJETO', text: mensagem }); } catch (err) {}
        } else {
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(mensagem)}`, '_blank');
        }
    }

    function enviarDados(nome, dia, status, obs) {
        fetch(URL_SISTEMA, { 
            method: 'POST', mode: 'no-cors', 
            body: JSON.stringify({ action: "upsert", data: { nome_aluno: nome, data: dia, status: status, obs: obs } }) 
        });
    }

    async function navegarMes(dir) { dataFoco.setMonth(dataFoco.getMonth() + dir); atualizarDias(); await carregarProjeto(); }

    window.onload = async () => {
        atualizarDias();
        try {
            const respT = await fetch(URL_TURMAS + "?table=turmas").then(r => r.json());
            const sel = document.getElementById('sel-turma');
            respT.forEach(t => { if(t.nome) sel.innerHTML += `<option value="${t.nome}">${t.nome}</option>`; });
        } catch(e) {}
        await carregarProjeto();
    };
</script>
</body>
</html>