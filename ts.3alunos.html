<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tsunami - Alunos</title>
    <style>
        :root { --bg: #050a12; --card: #0d1520; --cyan: #00e5ff; --red: #ff4d4d; --border: #1a2635; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; }
        .btn-voltar { color: var(--cyan); text-decoration: none; font-weight: bold; margin-bottom: 20px; display: block; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        .sidebar { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--border); }
        .field { margin-bottom: 15px; }
        .field label { display: block; font-size: 11px; margin-bottom: 5px; font-weight: bold; color: #8899a6; }
        input, select, textarea { width: 100%; background: #000; border: 1px solid var(--border); padding: 10px; border-radius: 8px; color: #fff; box-sizing: border-box; }
        textarea { height: 100px; resize: none; }
        .btn-cadastrar { width: 100%; background: var(--cyan); border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; color: #000; }
        .btn-cadastrar:hover { opacity: 0.9; }
        .aluno-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--cyan); display: flex; justify-content: space-between; align-items: center; }
        .info-detalhes { font-size: 12px; color: #8899a6; margin-top: 5px; display: flex; gap: 10px; }
        .btn-acao { background: none; border: none; cursor: pointer; font-size: 18px; margin-left: 10px; }
        .loading { text-align: center; color: var(--cyan); padding: 20px; }
        .erro { text-align: center; color: var(--red); padding: 20px; }
    </style>
</head>
<body>

    <a href="ts.1pagina-inicial.html" class="btn-voltar">‚Üê VOLTAR</a>

    <div class="main-layout">
        <div class="sidebar">
            <h3>Novo Cadastro</h3>
            <input type="hidden" id="oldNome">
            <div class="field">
                <label>TURMA DESTINO *</label>
                <select id="turma_select"><option value="">Carregando turmas...</option></select>
            </div>
            <div class="field">
                <label>MATR√çCULA / REMATR√çCULA</label>
                <input type="date" id="data_mat">
            </div>
            <div class="field">
                <label>VENCIMENTO</label>
                <input type="date" id="data_venc">
            </div>
            <div class="field">
                <label>NOMES (UM POR LINHA) *</label>
                <textarea id="lista_nomes" placeholder="Jo√£o Silva&#10;Maria Oliveira&#10;Pedro Santos"></textarea>
            </div>
            <button class="btn-cadastrar" onclick="salvar()">CADASTRAR</button>
        </div>

        <div>
            <h3>Alunos Cadastrados</h3>
            <div id="lista_alunos_container"><div class="loading">Carregando...</div></div>
        </div>
    </div>

    <script>
        // ‚úÖ URL CONFIGURADA CORRETAMENTE
        const URL = "https://script.google.com/macros/s/AKfycby-23cMovuAZ0m6JouTueAara4JIYnAQVvRImBzhZWMh26gWhm0aB_KiFpRo2t2CcEQCA/exec";

        function chamar(params, cb) {
            console.log("Chamando:", params);
            const s = document.createElement('script');
            const cbName = cb + '_' + Date.now();
            window[cbName] = function(d) { 
                console.log("Resposta:", d);
                window[cb](d); 
                delete window[cbName]; 
            };
            s.src = `${URL}?${params}&callback=${cbName}`;
            s.onerror = function() {
                alert("Erro de conex√£o com o servidor!");
            };
            document.body.appendChild(s);
            s.onload = () => document.body.removeChild(s);
        }

        // CARREGA AS TURMAS NO SELECT
        window.popTurmas = (dados) => {
            console.log("Turmas recebidas:", dados);
            const sel = document.getElementById('turma_select');
            if(!dados || dados.length === 0) { 
                sel.innerHTML = '<option value="">Crie uma turma primeiro</option>'; 
                return; 
            }
            sel.innerHTML = '<option value="">Selecione uma turma...</option>' + 
                dados.map(t => `<option value="${t.nome}">${t.nome}</option>`).join('');
        };

        function salvar() {
            const nomes = document.getElementById('lista_nomes').value.trim();
            const turma = document.getElementById('turma_select').value;
            const mat = document.getElementById('data_mat').value;
            const venc = document.getElementById('data_venc').value;
            const old = document.getElementById('oldNome').value;

            if(!nomes) return alert("‚ö†Ô∏è Digite pelo menos um nome!");
            if(!turma) return alert("‚ö†Ô∏è Selecione uma turma!");

            window.res = function(resp) { 
                if(resp && resp.status === "sucesso") {
                    alert("‚úÖ " + (resp.quantidade ? resp.quantidade + " alunos cadastrados!" : "Salvo com sucesso!")); 
                    location.reload(); 
                } else {
                    alert("‚ùå Erro: " + (resp ? resp.mensagem : "Sem resposta"));
                }
            };
            
            const params = `action=salvarAlunos&nomes=${encodeURIComponent(nomes)}&turma=${encodeURIComponent(turma)}&matricula=${mat}&vencimento=${venc}&oldNome=${encodeURIComponent(old)}`;
            chamar(params, "res");
        }

        window.renderAlunos = (dados) => {
            const container = document.getElementById('lista_alunos_container');
            if(!dados || dados.length === 0) {
                container.innerHTML = "<div class='erro'>Nenhum aluno cadastrado</div>";
                return;
            }
            
            container.innerHTML = dados.map(a => `
                <div class="aluno-card">
                    <div>
                        <strong>${a.nome}</strong>
                        <div class="info-detalhes">
                            <span>üë• ${a.turma}</span> 
                            <span>üìÖ Mat: ${a.matricula || '-'}</span>
                            <span>üí∞ Venc: ${a.vencimento || '-'}</span>
                        </div>
                    </div>
                    <div>
                        <button class="btn-acao" onclick="prepararEdicao('${a.nome.replace(/'/g, "\\'")}','${a.turma}','${a.matricula}','${a.vencimento}')" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-acao" onclick="excluir('${a.nome.replace(/'/g, "\\'")}')" title="Excluir">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        };

        function prepararEdicao(n, t, m, v) {
            document.getElementById('lista_nomes').value = n;
            document.getElementById('oldNome').value = n;
            document.getElementById('turma_select').value = t;
            document.getElementById('data_mat').value = m || '';
            document.getElementById('data_venc').value = v || '';
            document.querySelector('.btn-cadastrar').innerText = "SALVAR ALTERA√á√ïES";
            window.scrollTo(0,0);
        }

        function excluir(n) {
            if(!confirm("Excluir " + n + "?")) return;
            window.resEx = function(resp) {
                if(resp && resp.status === "excluido") {
                    alert("üóëÔ∏è Removido!");
                    location.reload();
                } else {
                    alert("‚ùå Erro ao excluir");
                }
            };
            chamar(`action=excluirAluno&nome=${encodeURIComponent(n)}`, "resEx");
        }

        window.onload = () => {
            chamar("action=getTurmas", "popTurmas");
            chamar("action=getAlunos", "renderAlunos");
        };
    </script>
</body>
</html>