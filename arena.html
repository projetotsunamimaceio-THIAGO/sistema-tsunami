<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSUNAMI - Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%); color: white; font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        .btn-emerald { border: 1px solid #10b981; background: rgba(16, 185, 129, 0.1); transition: all 0.3s; color: #10b981; }
        .btn-emerald:hover { background: #10b981; color: black; }
        .arena-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(16, 185, 129, 0.1); border-radius: 16px; }
        .header-arena { background: rgba(16, 185, 129, 0.1); border-bottom: 1px solid rgba(16, 185, 129, 0.2); }
        .freq-btn { width: 32px; height: 32px; border-radius: 6px; font-weight: bold; font-size: 12px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .freq-vazio { background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); color: transparent; }
        .freq-falta { background: rgba(244, 63, 94, 0.2); border-color: #f43f5e; color: #f43f5e; }
        .freq-presente { background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981; }
        .freq-atraso { background: rgba(251, 191, 36, 0.2); border-color: #fbbf24; color: #fbbf24; }
        .freq-justificado { background: rgba(6, 182, 212, 0.2); border-color: #06b6d4; color: #06b6d4; }
        .all-btn { background: #3b82f6; color: white; font-size: 9px; padding: 2px 8px; border-radius: 4px; cursor: pointer; border: none; font-weight: bold; display: block; margin: 0 auto; }
        .nm-badge { background: rgba(107, 114, 128, 0.2); color: #6b7280; font-size: 10px; padding: 2px 8px; border-radius: 4px; }
        .contador-faltas { background: rgba(244, 63, 94, 0.1); color: #f43f5e; font-size: 12px; padding: 4px 12px; border-radius: 20px; font-weight: bold; }
        .contador-presencas { color: #10b981; font-size: 12px; font-weight: bold; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border: 1px solid rgba(16, 185, 129, 0.1); text-align: center; padding: 8px; }
        .col-atleta { width: 250px; text-align: left; }
        .col-dia { width: 60px; }
        .col-faltas { width: 80px; }
        select { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); color: white; }
    </style>
</head>
<body class="p-4 md:p-8">
    <script>if (sessionStorage.getItem('tsunami_logged') !== 'true') { window.location.href = 'login.html'; }</script>

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <a href="index.html" class="btn-emerald px-4 py-2 rounded-lg text-xs uppercase font-bold"><i class="fas fa-arrow-left mr-2"></i>Voltar</a>
            <h1 class="text-2xl md:text-3xl font-bold text-emerald-400 tracking-widest uppercase text-center flex-1"><i class="fas fa-check-double mr-3"></i>Frequência Arena</h1>
            <div class="w-20"></div>
        </div>

        <div class="arena-card">
            <div class="header-arena p-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <button onclick="mudarMes(-1)" class="btn-emerald w-10 h-10 rounded-lg flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="tituloMes" class="text-lg font-bold uppercase tracking-wider text-emerald-300 min-w-[180px] text-center"></h2>
                    <button onclick="mudarMes(1)" class="btn-emerald w-10 h-10 rounded-lg flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                </div>
                <select id="filtroTurma" onchange="renderizar()" class="px-4 py-2 rounded-lg text-sm outline-none"><option value="">TODAS AS TURMAS</option></select>
            </div>

            <div class="overflow-x-auto">
                <table id="tabelaFrequencia">
                    <thead id="theadPrincipal"></thead>
                    <tbody id="corpoTabela"></tbody>
                    <tfoot id="tfootPrincipal"></tfoot>
                </table>
            </div>

            <div class="p-4 border-t border-emerald-500/20 flex flex-col md:flex-row gap-3 justify-end">
                <button onclick="sincronizar()" class="px-6 py-3 rounded-lg border border-cyan-500 text-cyan-400 hover:bg-cyan-500/10 transition text-xs uppercase font-bold"><i class="fas fa-sync mr-2"></i>Sincronizar</button>
                <button onclick="salvar()" id="btnSalvar" class="btn-emerald px-6 py-3 rounded-lg text-xs uppercase font-bold"><i class="fas fa-save mr-2"></i>Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalJust" class="modal">
        <div class="bg-gray-900 p-6 rounded-2xl max-w-md w-full mx-4 border border-cyan-500">
            <h3 class="text-xl font-bold text-cyan-400 mb-4 uppercase">Justificar Falta</h3>
            <input type="hidden" id="jA"><input type="hidden" id="jD">
            <textarea id="jT" class="w-full p-3 rounded-lg bg-black text-white text-sm mb-4" rows="3" placeholder="Motivo..."></textarea>
            <div class="flex gap-3">
                <button onclick="fecharJust()" class="flex-1 border border-gray-500 text-gray-400 p-3 rounded-lg uppercase text-xs font-bold">Cancelar</button>
                <button onclick="salvarJust()" class="flex-1 bg-cyan-500 text-black p-3 rounded-lg uppercase text-xs font-bold">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycby-23cMovuAZ0m6JouTueAara4JIYnAQVvRImBzhZWMh26gWhm0aB_KiFpRo2t2CcEQCA/exec";
        
        let alunos = JSON.parse(localStorage.getItem('tsunami_alunos')) || [];
        let turmas = JSON.parse(localStorage.getItem('tsunami_turmas')) || [];
        let freq = JSON.parse(localStorage.getItem('tsunami_freq')) || {}; // Dados locais
        let dataAtual = new Date();
        let dias = [];
        let lista = [];
        let editando = {}; // Alterações pendentes

        const CICLO = ['', 'F', 'P', 'A', 'J'];
        const CORES = { '': 'freq-vazio', 'F': 'freq-falta', 'P': 'freq-presente', 'A': 'freq-atraso', 'J': 'freq-justificado' };
        const TEXTO = {'P':'Presente','A':'Atraso','F':'Faltou','J':'Justificado'};

        // Converte data string para Date
        function toDate(str) {
            if (!str) return null;
            if (str instanceof Date) {
                const d = new Date(str);
                d.setHours(0,0,0,0);
                return d;
            }
            // DD/MM/YYYY
            if (str.includes('/')) {
                const [d,m,a] = str.split('/').map(Number);
                const r = new Date(a, m-1, d);
                r.setHours(0,0,0,0);
                return r;
            }
            // ISO
            const d = new Date(str);
            d.setHours(0,0,0,0);
            return d;
        }

        // Verifica se data está entre matrícula e vencimento
        function ativo(aluno, data) {
            const mat = toDate(aluno.matricula_rematricula);
            const ven = toDate(aluno.data_vencimento);
            const ref = new Date(data);
            ref.setHours(0,0,0,0);
            if (!mat || !ven) return false;
            return ref >= mat && ref <= ven;
        }

        // Verifica se aluno aparece no mês (há interseção)
        function noMes(aluno, ano, mes) {
            const mat = toDate(aluno.matricula_rematricula);
            const ven = toDate(aluno.data_vencimento);
            if (!mat || !ven) return false;
            const ini = new Date(ano, mes, 1);
            const fim = new Date(ano, mes + 1, 0, 23, 59, 59);
            return mat <= fim && ven >= ini;
        }

        // Chave única para frequência
        function chave(nome, data) {
            return nome + '|' + data.getTime();
        }

        // Busca status (editando primeiro, depois salvo)
        function getStatus(nome, data, a, d) {
            const k = chave(nome, data);
            const k2 = a + '-' + d;
            if (editando[k2] !== undefined) return editando[k2];
            if (freq[k]) return freq[k];
            return '';
        }

        function sabados(ano, mes) {
            const r = [];
            const d = new Date(ano, mes, 1);
            while (d.getDay() !== 6) d.setDate(d.getDate() + 1);
            while (d.getMonth() === mes) {
                const x = new Date(d);
                x.setHours(0,0,0,0);
                r.push(x);
                d.setDate(d.getDate() + 7);
            }
            return r;
        }

        function mudarMes(dir) {
            dataAtual.setMonth(dataAtual.getMonth() + dir);
            editando = {}; // Limpa edições ao mudar mês
            renderizar();
        }

        function renderizar() {
            const ano = dataAtual.getFullYear();
            const mes = dataAtual.getMonth();
            const nomesMes = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            
            document.getElementById('tituloMes').textContent = nomesMes[mes] + ' ' + ano;
            dias = sabados(ano, mes);
            
            const filtro = document.getElementById('filtroTurma').value;
            
            // Filtra alunos ativos no mês
            lista = alunos.filter(a => noMes(a, ano, mes))
                          .sort((a,b) => a.nome.localeCompare(b.nome));
            
            if (filtro) lista = lista.filter(a => a.turma === filtro);

            // Header
            let h = '<tr class="bg-emerald-500/5"><th class="col-atleta text-[10px] uppercase text-emerald-400 p-3">Atleta</th>';
            dias.forEach(d => {
                h += `<th class="col-dia p-2"><div style="font-size:9px;color:#9ca3af">SÁB</div><div style="font-size:18px;font-weight:bold;color:#34d399">${d.getDate()}</div></th>`;
            });
            h += '<th class="col-faltas text-[10px] uppercase text-emerald-400 p-3">Faltas</th></tr>';
            
            h += '<tr class="bg-blue-500/5"><td class="col-atleta text-[9px] uppercase text-blue-400 font-bold px-4 py-2">Ações Lote</td>';
            dias.forEach((_,i) => h += `<td class="col-dia p-2"><button onclick="lote(${i})" class="all-btn">ALL</button></td>`);
            h += '<td class="col-faltas"></td></tr>';
            
            document.getElementById('theadPrincipal').innerHTML = h;

            // Body
            const tbody = document.getElementById('corpoTabela');
            if (lista.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${2+dias.length}" class="p-8 text-center text-gray-500">Nenhum aluno ativo</td></tr>`;
                document.getElementById('tfootPrincipal').innerHTML = '';
                return;
            }

            tbody.innerHTML = lista.map((aluno, a) => {
                let r = `<tr><td class="col-atleta px-4 py-3"><div class="font-bold text-emerald-300 uppercase text-sm">${aluno.nome}</div><div class="text-[9px] text-gray-500">${aluno.turma||''}</div></td>`;
                
                dias.forEach((dia, d) => {
                    if (!ativo(aluno, dia)) {
                        r += `<td class="col-dia p-2"><span class="nm-badge">N/M</span></td>`;
                    } else {
                        const s = getStatus(aluno.nome, dia, a, d);
                        r += `<td class="col-dia p-2"><button onclick="ciclo(${a},${d})" class="freq-btn ${CORES[s]}">${s}</button></td>`;
                    }
                });
                
                // Conta faltas
                let f = 0;
                dias.forEach((dia, d) => {
                    if (ativo(aluno, dia)) {
                        const s = getStatus(aluno.nome, dia, a, d);
                        if (s === 'F' || s === 'J') f++;
                    }
                });
                
                r += `<td class="col-faltas"><span class="contador-faltas">${f}</span></td></tr>`;
                return r;
            }).join('');

            // Footer
            let f = '<tr class="bg-emerald-500/10"><td class="col-atleta text-[10px] uppercase text-emerald-400 font-bold px-4 py-3">Presenças / Dia</td>';
            dias.forEach((dia, d) => {
                let t = 0;
                lista.forEach((aluno, a) => {
                    if (ativo(aluno, dia)) {
                        const s = getStatus(aluno.nome, dia, a, d);
                        if (s === 'P' || s === 'A') t++;
                    }
                });
                f += `<td class="col-dia p-2"><span class="contador-presencas">${t}</span></td>`;
            });
            f += '<td class="col-faltas"></td></tr>';
            document.getElementById('tfootPrincipal').innerHTML = f;
        }

        function ciclo(a, d) {
            const aluno = lista[a];
            const dia = dias[d];
            if (!ativo(aluno, dia)) return;
            
            const k = a + '-' + d;
            const atual = editando[k] || getStatus(aluno.nome, dia, a, d) || '';
            const prox = CICLO[(CICLO.indexOf(atual) + 1) % CICLO.length];
            
            if (prox === 'J') {
                document.getElementById('jA').value = a;
                document.getElementById('jD').value = d;
                document.getElementById('modalJust').classList.add('active');
                return;
            }
            
            editando[k] = prox;
            renderizar();
        }

        function lote(d) {
            const dia = dias[d];
            let primeiro = '';
            
            for (let i = 0; i < lista.length; i++) {
                if (ativo(lista[i], dia)) {
                    primeiro = editando[i+'-'+d] || getStatus(lista[i].nome, dia, i, d) || '';
                    if (primeiro) break;
                }
            }
            
            const prox = CICLO[(CICLO.indexOf(primeiro) + 1) % CICLO.length];
            if (prox === 'J') return alert('Justificativa apenas individual');
            
            for (let i = 0; i < lista.length; i++) {
                if (ativo(lista[i], dia)) {
                    editando[i+'-'+d] = prox;
                }
            }
            renderizar();
        }

        function fecharJust() {
            document.getElementById('modalJust').classList.remove('active');
        }

        function salvarJust() {
            const a = document.getElementById('jA').value;
            const d = document.getElementById('jD').value;
            editando[a+'-'+d] = 'J';
            editando[a+'-'+d+'-txt'] = document.getElementById('jT').value;
            fecharJust();
            renderizar();
        }

        async function salvar() {
            const btn = document.getElementById('btnSalvar');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
            btn.disabled = true;

            // Envia para planilha
            for (let a = 0; a < lista.length; a++) {
                for (let d = 0; d < dias.length; d++) {
                    const aluno = lista[a];
                    const dia = dias[d];
                    
                    if (!ativo(aluno, dia)) continue;
                    
                    const k = a + '-' + d;
                    const s = editando[k];
                    if (!s) continue; // Só salva o que foi editado
                    
                    // Atualiza local
                    freq[chave(aluno.nome, dia)] = s;
                    if (editando[k+'-txt']) {
                        freq[chave(aluno.nome, dia)+'-txt'] = editando[k+'-txt'];
                    }
                    
                    // Envia
                    const fd = new FormData();
                    fd.append('action', 'frequencia');
                    fd.append('nome', aluno.nome);
                    fd.append('data_aula', dia.toLocaleDateString('pt-BR'));
                    fd.append('status', TEXTO[s]);
                    fd.append('justificativa', editando[k+'-txt'] || '');
                    
                    try { await fetch(URL_SCRIPT, {method:'POST', body:fd}); } catch(e) {}
                }
            }
            
            // Salva local
            localStorage.setItem('tsunami_freq', JSON.stringify(freq));
            editando = {};
            
            btn.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar';
            btn.disabled = false;
            alert('Salvo!');
            renderizar();
        }

        async function sincronizar() {
            document.getElementById('corpoTabela').innerHTML = '<tr><td colspan="20" class="p-8 text-center text-emerald-400"><i class="fas fa-spinner fa-spin mr-2"></i>Sincronizando...</td></tr>';
            
            try {
                // Alunos
                const r1 = await fetch(URL_SCRIPT + '?getDados=alunos');
                const d1 = await r1.json();
                if (Array.isArray(d1)) {
                    alunos = d1;
                    localStorage.setItem('tsunami_alunos', JSON.stringify(alunos));
                }
                
                // Turmas
                const r2 = await fetch(URL_SCRIPT + '?getDados=turmas');
                const d2 = await r2.json();
                if (Array.isArray(d2)) {
                    turmas = d2;
                    localStorage.setItem('tsunami_turmas', JSON.stringify(turmas));
                }
                
                // Frequência
                const r3 = await fetch(URL_SCRIPT + '?getDados=frequencia');
                const d3 = await r3.json();
                if (Array.isArray(d3)) {
                    freq = {};
                    d3.forEach(f => {
                        const dt = toDate(f.data_aula);
                        if (dt) {
                            freq[chave(f.nome, dt)] = (f.status === 'Presente' ? 'P' : 
                                                       f.status === 'Atraso' ? 'A' : 
                                                       f.status === 'Faltou' ? 'F' : 
                                                       f.status === 'Justificado' ? 'J' : '');
                            if (f.justificativa) {
                                freq[chave(f.nome, dt)+'-txt'] = f.justificativa;
                            }
                        }
                    });
                    localStorage.setItem('tsunami_freq', JSON.stringify(freq));
                }
            } catch(e) {
                console.error(e);
            }
            
            // Atualiza select
            const sel = document.getElementById('filtroTurma');
            const val = sel.value;
            sel.innerHTML = '<option value="">TODAS AS TURMAS</option>';
            turmas.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(t => {
                const o = document.createElement('option');
                o.value = t.nome;
                o.textContent = t.nome;
                sel.appendChild(o);
            });
            sel.value = val;
            
            renderizar();
        }

        // Inicia
        sincronizar();
    </script>
</body>
</html>